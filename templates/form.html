<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>GPX Waypoints Generator</title>
    <style>
        table {
            width: 100%;
        }

        th,
        td {
            padding: 5px;
            text-align: left;
        }

        #map {
            width: 100%;
            height: 400px;
            margin-bottom: 20px;
        }

        #coordinate-container {
            width: 100%;
            max-height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }
    </style>
    <script>
        let nextRowId = 0;
        let map;
        let waypoints = [];
        let polyline;

        // Function to initialize Google Maps
        function initMap() {
            // Initialize with default coordinates
            const defaultCenter = { lat: 34.05509557203397, lng: -118.24375334349435 };

            // Create the map object
            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultCenter,
                zoom: 14
            });

            // Initialize the polyline that will connect waypoints
            polyline = new google.maps.Polyline({
                path: waypoints,
                geodesic: true,
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 2
            });
            polyline.setMap(map);

            // Attempt to get the user's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const userLatLng = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Center the map on the user's location
                    map.setCenter(userLatLng);
                    map.setZoom(14);

                    // Optionally, add a marker to represent the current location
                    new google.maps.Marker({
                        position: userLatLng,
                        map: map,
                        title: 'Your Location'
                    });
                }, function () {
                    // On error or permission denial, fall back to the default coordinates
                    map.setCenter(defaultCenter);
                });
            } else {
                // If Geolocation is not supported by the browser
                map.setCenter(defaultCenter);
            }

            // Listen for right-click events on the map
            map.addListener('rightclick', function (event) {
                const lat = event.latLng.lat().toFixed(6);
                const lon = event.latLng.lng().toFixed(6);
                addCoordinatesToFormAndMap(lat, lon);
            });
        }

        // Function to add coordinates to the form and map
        function addCoordinatesToFormAndMap(lat, lon) {
            // Populate the latitude and longitude fields
            document.getElementById('lat-' + nextRowId).value = lat;
            document.getElementById('lon-' + nextRowId).value = lon;
            nextRowId++;
            addRow(nextRowId);
            document.getElementById('lat-' + nextRowId).focus();

            // Add marker on the map
            const position = new google.maps.LatLng(lat, lon);
            waypoints.push(position);
            new google.maps.Marker({
                position: position,
                map: map
            });

            // Update polyline path
            polyline.setPath(waypoints);
        }

        // Function to add a new row dynamically
        function addRow(rowId) {
            const newRow = `
                <tr id="row-${rowId}">
                    <td><input type="text" id="lat-${rowId}" name="lat[]" placeholder="Latitude"></td>
                    <td><input type="text" id="lon-${rowId}" name="lon[]" placeholder="Longitude"></td>
                </tr>
            `;
            const table = document.getElementById('coordinate-table-body');
            table.insertAdjacentHTML('beforeend', newRow);
        }

        // Function to center the map on the user's current location via a button click
        function centerOnCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const userLatLng = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Center the map on the user's location
                    map.setCenter(userLatLng);
                    map.setZoom(14);

                    // Optionally, add a marker to represent the current location
                    new google.maps.Marker({
                        position: userLatLng,
                        map: map,
                        title: 'Your Location'
                    });
                }, function () {
                    alert("Error: Unable to retrieve your location.");
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        // Initial function call to set up the first input row
        document.addEventListener('DOMContentLoaded', () => addRow(nextRowId));
    </script>
</head>

<body>
    <h1>GPX Waypoints Generator</h1>

    <!-- Map Element -->
    <div id="map"></div>

    <!-- Center on Current Location Button -->
    <button onclick="centerOnCurrentLocation()">Center on Current Location</button>

    <!-- Scrollable Container and Form for the Coordinates -->
    <form action="/generate" method="post">
        <div id="coordinate-container">
            <table id="coordinate-table">
                <thead>
                    <tr>
                        <th>Latitude</th>
                        <th>Longitude</th>
                    </tr>
                </thead>
                <tbody id="coordinate-table-body"></tbody>
            </table>
        </div>
        <input type="submit" value="Generate GPX">
    </form>

    <!-- Google Maps JavaScript API -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"></script>

</body>

</html>